---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
house <- read.csv("/Users/atticusw/Desktop/pton-market-data.csv")

#Tidying up

house <- house %>% 
  mutate(Price = strtoi(str_replace_all(str_sub(Sold.Price, 2, -4), ",", ""))) %>%
  rename(nbhd = Neighborhood, bed = Bed.Rooms, fullBath = Full.Baths, halfBath = Half.Baths, style = Style, age = Year.Built) %>%
  rename(lotSize = Lot.Size, lastPrice = Last.Price, originalPrice = Original.Price, soldPrice = Price) %>%
  select(- Sold.Price) %>%
  rename(marketDays = Days.on.Market) %>%
  separate(col = Sold.Date, into = c("monthSold", "daySold", "yearSold"), sep = "/") %>%
  mutate(yearSold = strtoi(yearSold) + 2000) %>%
  mutate(daySold = strtoi(daySold), monthSold = strtoi(monthSold)) %>%
  mutate(age = yearSold - strtoi(age)) %>%
  select(- Property.Marketing.Period) %>%
  mutate(originalPrice = strtoi(str_replace_all(str_sub(originalPrice, 2, -4), ",", ""))) %>%
  mutate(lastPrice = strtoi(str_replace_all(str_sub(lastPrice, 2, -4), ",", ""))) %>%
  select(- X) %>%
  mutate(lotSize = as.double(lotSize)) %>%
  select(- Address) %>%
  mutate(marketDays = strtoi(marketDays))
```

---OUR PLAN---

Response variable: soldPrice (price at which the house was sold)

Possible predictors:
- nbhd (neighborhood)
- bed (number of bedrooms)
- fullBath (number of full baths)
- halfBath (number of half baths)
- style (style)
- age (yearSold minus yearBuilt)
- originalPrice (original price)
- lastPrice (price at which the house was last sold)
- marketDays (days the house was on market)
- yearSold, daySold, monthSold (date at which the house was sold)

Regression methods we will use: 
- full linear model (lm)
- subset selection (sub)
- ridge (ridge)
- lasso (lasso)
- elastic net (ela)
- principal components (pcr)


```{r}
#some final tidying

badStyles <- house %>% 
  group_by(style) %>%
  summarise(count = n()) %>%
  arrange(count) %>%
  head(43)

house <- house %>%
  select(- lotSize) %>%     #too many NAs
  select(- originalPrice) %>%
  select(- lastPrice) %>%  #we omit these two predictors because they are too similar to the response variable 
  mutate(nbhd = replace(nbhd, nbhd == "Battelfield Area", "Battlefield Area"), nbhd = replace(nbhd, nbhd == "princeton Ridge", "Princeton Ridge"), nbhd = replace(nbhd, nbhd == "LIttlebrook", "Littlebrook"), nbhd = replace(nbhd, nbhd == "griggs Farm", "Griggs Farm"), nbhd = replace(nbhd, nbhd == "PrettyBrook Area", "Pretty Brook Area"), nbhd = replace(nbhd, nbhd == "Palmer Sq", "Palmer Square"), nbhd = replace(nbhd, nbhd == "Institute", "Institute Area"), nbhd = replace(nbhd, nbhd == "Rriverside", "Riverside"), nbhd = replace(nbhd, nbhd == "Rriverside", "Riverside"), nbhd = replace(nbhd, nbhd == "Carnegie Lake", "Carnegie Lake Area"), nbhd = replace(nbhd, nbhd == "Town", "Township")) %>%     #fix area names
  filter(! nbhd %in% c("Edgerstoune", "Northridge", "Rushbrook", "Russell Estates", "The Preserve", "Governors Lane", "Princeton Borough", "Preserve", "Queenston")) %>%  #delete areas with few houses
  filter(! style %in% badStyles$style) %>%  #delete styles with at most 3 houses
  mutate(style = replace(style, style == "Bi-level", "Bi-Level"), style = replace(style, style == "End Unit", "End-Unit"), style = replace(style, style == "Townhouse", "Townhome"))  #fix style names

house <- house %>%
  na.omit()
```

```{r}
#normalize numerical data

houseNorm <- house %>%
  mutate_at(c("bed", "fullBath", "halfBath", "age", "monthSold", "daySold", "yearSold", "marketDays"), ~(scale(.) %>% as.vector))


#divide data into 10 parts for cross-validation

set.seed(42)
houseSplit <- houseNorm
houseSplit$id <- sample(0:9, size = nrow(houseSplit), replace = TRUE)
houseSplit %>%
  group_by(id) %>%
  summarize(count = n())
```


```{r}
#define evaluation metrics: returns R-squared and RMS error

evalMetrics <- function(model, df, predictions, target){
    resids = df[,target] - predictions
    resids2 = resids**2
    N = length(predictions)
    r2 = round(summary(model)$r.squared, 3)
    adjR2 = round(summary(model)$adj.r.squared, 3)
    rmse = round(sqrt(sum(resids2)/N), 3)
    return(c(adjR2, rmse))
}

#performance prints two numbers: the first one average R-squared, the second one average RMSE (standard deviation of the ten RMS)

performance <- function(df, modelName) {
  pf <- data.frame(modelName(houseSplit, 0))
  for (i in 1:9) {
    pf <- cbind(pf, modelName(houseSplit, i))
  }
  pf <- t(pf)
  print(pf)
  print(c(mean(pf[,1]), mean(pf[,2])))
}
```


```{r}
#now we define the regression models!

#linear regression model using all predictors

linearModel <- function(df, testSet) {
  lr <- lm(soldPrice ~ ., data = select(filter(df, id != testSet), -id))
  summary(lr)
  predictions <- predict(lr, newdata = select(filter(df, id == testSet), -id))
  evalMetrics(lr, select(filter(df, id == testSet), -id), predictions, target = "soldPrice")
}

#linear regression with a subset of the predictors
#we use the step function for this

forwardModel <- function(df, testSet) {
  fitNone <- lm(soldPrice ~ 1 , data = select(filter(df, id != testSet), -id))
  forward <- step(fitNone, direction = "forward", trace = 0, scope = formula(lm(soldPrice ~ ., data = select(filter(df, id != testSet), -id))))
  predForward <- predict(forward, newdata = select(filter(df, id == testSet), -id))
  evalMetrics(forward, select(filter(df, id == testSet), -id), predForward, target = "soldPrice")
}

backwardModel <- function(df, testSet) {
  fitAll <- lm(soldPrice ~ ., data = select(filter(df, id != testSet), -id))
  backward <- step(fitAll, direction = "backward", trace = 0)
  predBackward <- predict(backward, newdata = select(filter(df, id == testSet), -id))
  evalMetrics(backward, select(filter(df, id == testSet), -id), predBackward, target = "soldPrice")
}

performance(houseSplit, linearModel)
performance(houseSplit, forwardModel)
performance(houseSplit, backwardModel)
```

```{r}
#we will use the glmnet package to build regularized regression models
#these include ridge, lasso, and elastic net

# install.packages("glmnet")
# install.packages("caret")
library(glmnet)
library(caret)

dummies <- dummyVars(soldPrice ~ ., data = houseSplit[,colnames(houseNorm)])
```





